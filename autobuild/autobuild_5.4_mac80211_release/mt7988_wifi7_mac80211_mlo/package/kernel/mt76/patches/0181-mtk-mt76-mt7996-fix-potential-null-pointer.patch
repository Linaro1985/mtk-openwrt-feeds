From 8eb1331774a9e57e65bf03af4e0835ec6ecd887a Mon Sep 17 00:00:00 2001
From: Shayne Chen <shayne.chen@mediatek.com>
Date: Tue, 9 Jul 2024 14:54:39 +0800
Subject: [PATCH 181/206] mtk: mt76: mt7996: fix potential null pointer

Fix more parts that might have null pointer access.

Signed-off-by: Shayne Chen <shayne.chen@mediatek.com>
---
 mt7996/mac.c  | 3 +++
 mt7996/main.c | 7 +++++++
 2 files changed, 10 insertions(+)

diff --git a/mt7996/mac.c b/mt7996/mac.c
index f74926b0..05a8c0cd 100644
--- a/mt7996/mac.c
+++ b/mt7996/mac.c
@@ -1115,6 +1115,9 @@ mt7996_tx_check_aggr(struct ieee80211_sta *sta, struct sk_buff *skb,
 
 	msta = (struct mt7996_sta *)sta->drv_priv;
 	mlink = rcu_dereference(msta->link[msta->pri_link]);
+	if (!mlink)
+		return;
+
 	if (!test_and_set_bit(tid, &mlink->wcid.ampdu_state))
 		ieee80211_start_tx_ba_session(sta, tid, 0);
 }
diff --git a/mt7996/main.c b/mt7996/main.c
index f8c6010e..a9938146 100644
--- a/mt7996/main.c
+++ b/mt7996/main.c
@@ -518,9 +518,12 @@ static void mt7996_remove_interface(struct ieee80211_hw *hw,
 
 	conf = link_conf_dereference_protected(vif, 0);
 	mconf = mconf_dereference_protected(mvif, 0);
+	if (!mconf || !conf)
+		goto out;
 
 	mt7996_remove_bss_conf(vif, conf, mconf);
 
+out:
 	mutex_unlock(&dev->mt76.mutex);
 }
 
@@ -1270,6 +1273,8 @@ mt7996_mac_sta_remove_links(struct mt7996_dev *dev, struct ieee80211_vif *vif,
 			link_sta_dereference_protected(sta, link_id);
 		bool last_link = rem == sta->valid_links && link_id == __fls(rem);
 
+		if (!mconf || !mlink || !conf || !link_sta)
+			continue;
 		mt7996_remove_link_sta(dev, conf, mconf, link_sta, mlink, last_link);
 	}
 }
@@ -1406,6 +1411,8 @@ mt7996_sta_pre_rcu_remove(struct ieee80211_hw *hw, struct ieee80211_vif *vif,
 		struct mt7996_link_sta *mlink =
 			mlink_dereference_protected(msta, link_id);
 
+		if (!mlink)
+			continue;
 		rcu_assign_pointer(dev->mt76.wcid[mlink->wcid.idx], NULL);
 	}
 	spin_unlock_bh(&dev->mt76.status_lock);
-- 
2.18.0


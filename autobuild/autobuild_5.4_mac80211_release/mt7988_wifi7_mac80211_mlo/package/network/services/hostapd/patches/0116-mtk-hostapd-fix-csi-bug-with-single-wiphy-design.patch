From 6a0dc89d09507dfe20ecdd46894e7c3ff2d1dba8 Mon Sep 17 00:00:00 2001
From: mtk20656 <chank.chen@mediatek.com>
Date: Thu, 20 Jun 2024 19:13:30 +0800
Subject: [PATCH 116/137] mtk: hostapd: fix csi bug with single wiphy design

[Description]
fix hostapd part.

Signed-off-by: mtk20656 <chank.chen@mediatek.com>
---
 src/ap/ap_drv_ops.c          | 4 ++--
 src/common/mtk_vendor.h      | 2 ++
 src/drivers/driver.h         | 6 ++++--
 src/drivers/driver_nl80211.c | 8 ++++++--
 4 files changed, 14 insertions(+), 6 deletions(-)

diff --git a/src/ap/ap_drv_ops.c b/src/ap/ap_drv_ops.c
index 05d51686c..ae2be90b6 100644
--- a/src/ap/ap_drv_ops.c
+++ b/src/ap/ap_drv_ops.c
@@ -1477,12 +1477,12 @@ int hostapd_drv_csi_set(struct hostapd_data *hapd, u8 mode, u8 cfg, u8 v1, u32 v
 {
 	if (!hapd->driver || !hapd->driver->csi_set)
 		return 0;
-	return hapd->driver->csi_set(hapd->drv_priv, mode, cfg, v1, v2, mac);
+	return hapd->driver->csi_set(hapd->drv_priv, hapd->iconf->band_idx, mode, cfg, v1, v2, mac);
 }
 
 int hostapd_drv_csi_dump(struct hostapd_data *hapd, void *dump_buf)
 {
 	if (!hapd->driver || !hapd->driver->csi_dump)
 		return 0;
-	return hapd->driver->csi_dump(hapd->drv_priv, dump_buf);
+	return hapd->driver->csi_dump(hapd->drv_priv, hapd->iconf->band_idx, dump_buf);
 }
diff --git a/src/common/mtk_vendor.h b/src/common/mtk_vendor.h
index 932a01400..c6de8862b 100644
--- a/src/common/mtk_vendor.h
+++ b/src/common/mtk_vendor.h
@@ -79,6 +79,8 @@ enum mtk_vendor_attr_csi_ctrl {
 
 	MTK_VENDOR_ATTR_CSI_CTRL_DATA,
 
+        MTK_VENDOR_ATTR_CSI_CTRL_BAND_IDX,
+
 	/* keep last */
 	NUM_MTK_VENDOR_ATTRS_CSI_CTRL,
 	MTK_VENDOR_ATTR_CSI_CTRL_MAX =
diff --git a/src/drivers/driver.h b/src/drivers/driver.h
index ebc9b786d..aa158aa05 100644
--- a/src/drivers/driver.h
+++ b/src/drivers/driver.h
@@ -5389,19 +5389,21 @@ struct wpa_driver_ops {
 	/**
 	 * csi_set - Set csi related mode and parameter
 	 * @priv: Private driver interface data
+	 * @band_idx: band idx
 	 * @mode: Csi mode parameter
 	 * @cfg: Csi config parameter
 	 * @v1: Value1
 	 * @v2: Value2
 	 * @mac: Station mac for station filter
 	 */
-	int (*csi_set)(void *priv, u8 mode, u8 cfg, u8 v1, u32 v2, u8 *mac);
+	int (*csi_set)(void *priv, u8 band_idx, u8 mode, u8 cfg, u8 v1, u32 v2, u8 *mac);
 	/**
 	* csi_dump - Dump csi data to json file
 	* @priv: Private driver interface data
+	* @band_idx: band idx
 	* @dump_buf: Dump_struct that store csi data and related info
 	*/
-	int (*csi_dump)(void *priv, void *dump_buf);
+	int (*csi_dump)(void *priv, u8 band_idx, void *dump_buf);
 };
 
 /**
diff --git a/src/drivers/driver_nl80211.c b/src/drivers/driver_nl80211.c
index 67a33edaf..edda40c48 100644
--- a/src/drivers/driver_nl80211.c
+++ b/src/drivers/driver_nl80211.c
@@ -163,6 +163,7 @@ pp_ctrl_policy[NUM_MTK_VENDOR_ATTRS_PP_CTRL] = {
 };
 
 static struct nla_policy csi_ctrl_policy[NUM_MTK_VENDOR_ATTRS_CSI_CTRL] = {
+	[MTK_VENDOR_ATTR_CSI_CTRL_BAND_IDX] = { .type = NLA_U8 },
 	[MTK_VENDOR_ATTR_CSI_CTRL_CFG] = { .type = NLA_NESTED },
 	[MTK_VENDOR_ATTR_CSI_CTRL_CFG_MODE] = { .type = NLA_U8 },
 	[MTK_VENDOR_ATTR_CSI_CTRL_CFG_TYPE] = { .type = NLA_U8 },
@@ -15340,7 +15341,7 @@ fail:
 #endif
 
 static int
-nl80211_csi_set(void *priv, u8 mode, u8 cfg, u8 v1, u32 v2, u8 *mac)
+nl80211_csi_set(void *priv, u8 band_idx, u8 mode, u8 cfg, u8 v1, u32 v2, u8 *mac)
 {
 	struct i802_bss *bss = priv;
 	struct wpa_driver_nl80211_data *drv = bss->drv;
@@ -15368,6 +15369,8 @@ nl80211_csi_set(void *priv, u8 mode, u8 cfg, u8 v1, u32 v2, u8 *mac)
 	if (!data)
 		goto fail;
 
+	nla_put_u8(msg, MTK_VENDOR_ATTR_CSI_CTRL_BAND_IDX, band_idx);
+
 	tb1 = nla_nest_start(msg, MTK_VENDOR_ATTR_CSI_CTRL_CFG | NLA_F_NESTED);
 	if (!tb1)
 		goto fail;
@@ -15492,7 +15495,7 @@ mt76_csi_dump_cb(struct nl_msg *msg, void *arg)
 }
 
 static int
-nl80211_csi_dump(void *priv, void *dump_buf)
+nl80211_csi_dump(void *priv, u8 band_idx, void *dump_buf)
 {
 	struct i802_bss *bss = priv;
 	struct wpa_driver_nl80211_data *drv = bss->drv;
@@ -15529,6 +15532,7 @@ nl80211_csi_dump(void *priv, void *dump_buf)
 		if (!data)
 			goto fail;
 
+		nla_put_u8(msg, MTK_VENDOR_ATTR_CSI_CTRL_BAND_IDX, band_idx);
 		nla_put_u16(msg, MTK_VENDOR_ATTR_CSI_CTRL_DUMP_NUM, CSI_DUMP_PER_NUM);
 
 		nla_nest_end(msg, data);
-- 
2.18.0

